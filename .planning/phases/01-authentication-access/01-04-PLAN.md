---
phase: 01-authentication-access
plan: 04
type: execute
wave: 4
depends_on: ["03"]
files_modified:
  - apps/web/app/auth/callback/route.ts
  - apps/web/middleware.ts
  - apps/web/app/dashboard/page.tsx
autonomous: true
user_setup:
  - service: workos
    why: "AuthKit callback and session protection"
    env_vars:
      - name: WORKOS_API_KEY
        source: "WorkOS Dashboard -> API Keys"
      - name: WORKOS_CLIENT_ID
        source: "WorkOS Dashboard -> Project Settings"
      - name: WORKOS_COOKIE_PASSWORD
        source: "Generate 32+ char secret (local secret manager)"
      - name: WORKOS_REDIRECT_URI
        source: "WorkOS Dashboard -> Redirect URIs"
    dashboard_config:
      - task: "Add redirect URI pointing to /auth/callback"
        location: "WorkOS Dashboard -> Redirect URIs"

must_haves:
  truths:
    - "AuthKit callback route exchanges auth codes for a session cookie"
    - "Authenticated users can access /dashboard; unauthenticated users are redirected to sign-in"
    - "Protected routes are enforced by AuthKit middleware"
    - "Signed-in users can trigger a sign-out action"
  artifacts:
    - path: "apps/web/app/auth/callback/route.ts"
      provides: "AuthKit callback handler"
      exports: ["GET"]
    - path: "apps/web/middleware.ts"
      provides: "AuthKit middleware with matcher"
    - path: "apps/web/app/dashboard/page.tsx"
      provides: "Signed-in dashboard view"
  key_links:
    - from: "apps/web/app/auth/callback/route.ts"
      to: "@workos-inc/authkit-nextjs"
      via: "handleAuth()"
      pattern: "handleAuth"
    - from: "apps/web/middleware.ts"
      to: "/dashboard"
      via: "matcher config"
      pattern: "dashboard"
    - from: "apps/web/middleware.ts"
      to: "@workos-inc/authkit-nextjs"
      via: "authkitMiddleware()"
      pattern: "authkitMiddleware"
    - from: "apps/web/app/dashboard/page.tsx"
      to: "getSignInUrl/withAuth"
      via: "signed-in guard"
      pattern: "withAuth|getSignInUrl"
---

<objective>
Add the AuthKit callback and protected route enforcement.

Purpose: Establish the full WorkOS session lifecycle and protected page access.
Output: Callback route, middleware, and a protected dashboard page.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-access/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AuthKit callback route</name>
  <files>apps/web/app/auth/callback/route.ts</files>
  <action>
    - Create app/auth/callback/route.ts and export GET = handleAuth() from @workos-inc/authkit-nextjs.
    - Keep the route minimal and server-only.
  </action>
  <verify>pnpm -C apps/web build</verify>
  <done>AuthKit callback route exists and builds without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce session protection on /dashboard</name>
  <files>apps/web/middleware.ts, apps/web/app/dashboard/page.tsx</files>
  <action>
    - Add middleware.ts that exports authkitMiddleware() with a matcher limited to /dashboard/:path* (avoid static assets).
    - Create app/dashboard/page.tsx as a server component that calls withAuth(); if no user, redirect to await getSignInUrl().
    - When signed in, render a simple dashboard view (e.g., user email) with a sign-out form using signOut() server action.
  </action>
  <verify>pnpm -C apps/web build</verify>
  <done>/dashboard is protected by middleware and renders user info when authenticated.</done>
</task>

</tasks>

<verification>
- pnpm -C apps/web build completes successfully
</verification>

<success_criteria>
- Auth callback route is wired and reachable at /auth/callback
- /dashboard requires authentication and redirects unauthenticated users to WorkOS sign-in
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-access/01-04-SUMMARY.md`
</output>
