---
phase: 02-org-structure-languages
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/app/ConvexClientProvider.tsx
  - apps/web/app/layout.tsx
  - apps/web/hooks/useStoreUserEffect.ts
autonomous: true

must_haves:
  truths:
    - "Convex client receives WorkOS access token"
    - "User document is stored in Convex on authentication"
    - "Components can use useQuery/useMutation hooks"
  artifacts:
    - path: "apps/web/app/ConvexClientProvider.tsx"
      provides: "Convex + WorkOS auth bridge"
      contains: "ConvexProviderWithAuth"
    - path: "apps/web/hooks/useStoreUserEffect.ts"
      provides: "Auto-store user hook"
      exports: ["useStoreUserEffect"]
  key_links:
    - from: "apps/web/app/ConvexClientProvider.tsx"
      to: "apps/web/app/layout.tsx"
      via: "Provider wrapping children"
      pattern: "ConvexClientProvider"
    - from: "apps/web/hooks/useStoreUserEffect.ts"
      to: "api.users.store"
      via: "useMutation call"
      pattern: "api\\.users\\.store"
---

<objective>
Create ConvexClientProvider that bridges WorkOS auth with Convex and auto-stores users on login.

Purpose: Connect frontend to Convex backend with authenticated access
Output: Working provider that makes Convex hooks available throughout the app
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-org-structure-languages/02-RESEARCH.md
@apps/web/app/layout.tsx
@apps/web/convex/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConvexClientProvider component</name>
  <files>apps/web/app/ConvexClientProvider.tsx</files>
  <action>
Create ConvexClientProvider.tsx that bridges WorkOS AuthKit with Convex:

```typescript
"use client";

import { ReactNode, useCallback, useRef, useEffect } from "react";
import { ConvexReactClient, ConvexProviderWithAuth, useMutation } from "convex/react";
import { useAuth, useAccessToken } from "@workos-inc/authkit-nextjs/components";
import { api } from "../convex/_generated/api";

// Initialize Convex client
const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

// Custom hook to bridge WorkOS auth state to Convex
function useAuthFromAuthKit() {
  const { user, loading: isLoading } = useAuth();
  const { accessToken, loading: tokenLoading, error: tokenError } = useAccessToken();

  const loading = (isLoading ?? false) || (tokenLoading ?? false);
  const authenticated = !!user && !!accessToken && !loading;

  // Keep stable reference to access token
  const stableAccessToken = useRef<string | null>(null);
  if (accessToken && !tokenError) {
    stableAccessToken.current = accessToken;
  }

  const fetchAccessToken = useCallback(async () => {
    if (stableAccessToken.current && !tokenError) {
      return stableAccessToken.current;
    }
    return null;
  }, [tokenError]);

  return {
    isLoading: loading,
    isAuthenticated: authenticated,
    fetchAccessToken,
  };
}

// Hook to store user in Convex when authenticated
function useStoreUserEffect() {
  const { isAuthenticated, isLoading } = useAuthFromAuthKit();
  const storeUser = useMutation(api.users.store);
  const hasStored = useRef(false);

  useEffect(() => {
    // Only store once when authenticated and not loading
    if (isAuthenticated && !isLoading && !hasStored.current) {
      hasStored.current = true;
      storeUser().catch((err) => {
        console.error("Failed to store user:", err);
        // Reset so we can retry
        hasStored.current = false;
      });
    }
    // Reset when user logs out
    if (!isAuthenticated && !isLoading) {
      hasStored.current = false;
    }
  }, [isAuthenticated, isLoading, storeUser]);
}

// Inner component that uses Convex hooks
function ConvexAuthSync({ children }: { children: ReactNode }) {
  useStoreUserEffect();
  return <>{children}</>;
}

// Main provider component
export function ConvexClientProvider({ children }: { children: ReactNode }) {
  return (
    <ConvexProviderWithAuth client={convex} useAuth={useAuthFromAuthKit}>
      <ConvexAuthSync>{children}</ConvexAuthSync>
    </ConvexProviderWithAuth>
  );
}
```

Key behaviors:
- `useAuthFromAuthKit`: Bridges WorkOS auth state to Convex expected format
- `useStoreUserEffect`: Automatically stores user in Convex on first auth
- `ConvexAuthSync`: Inner component to use hooks inside Convex provider
- Uses stable refs to prevent unnecessary re-renders
  </action>
  <verify>
- `cat apps/web/app/ConvexClientProvider.tsx` shows provider component
- Component exports ConvexClientProvider
- Uses useAuthFromAuthKit for token bridge
- Includes useStoreUserEffect for user sync
  </verify>
  <done>ConvexClientProvider bridges WorkOS tokens to Convex client</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConvexClientProvider into layout</name>
  <files>apps/web/app/layout.tsx</files>
  <action>
Update layout.tsx to include ConvexClientProvider:

```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import { AuthKitProvider } from "@workos-inc/authkit-nextjs/components";
import { ConvexClientProvider } from "./ConvexClientProvider";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "GospelSmarts",
  description: "Share gospel content across languages",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <AuthKitProvider>
          <ConvexClientProvider>{children}</ConvexClientProvider>
        </AuthKitProvider>
      </body>
    </html>
  );
}
```

Changes:
- Import ConvexClientProvider
- Wrap children with ConvexClientProvider INSIDE AuthKitProvider
- Order matters: AuthKitProvider -> ConvexClientProvider -> children
  </action>
  <verify>
- `cat apps/web/app/layout.tsx` shows ConvexClientProvider imported and used
- Provider is nested inside AuthKitProvider
  </verify>
  <done>ConvexClientProvider integrated into app layout</done>
</task>

<task type="auto">
  <name>Task 3: Create standalone useStoreUserEffect hook</name>
  <files>apps/web/hooks/useStoreUserEffect.ts</files>
  <action>
Create a standalone version of the hook for use outside the provider (edge cases):

```typescript
"use client";

import { useEffect, useRef } from "react";
import { useMutation, useConvexAuth } from "convex/react";
import { api } from "../convex/_generated/api";

/**
 * Hook to ensure current user is stored in Convex database.
 * Call this in authenticated pages/components to ensure user exists in DB.
 * 
 * Note: This is also called automatically by ConvexClientProvider,
 * so you typically don't need to call it manually.
 */
export function useStoreUserEffect() {
  const { isAuthenticated, isLoading } = useConvexAuth();
  const storeUser = useMutation(api.users.store);
  const hasStored = useRef(false);

  useEffect(() => {
    // Only store once when authenticated and not loading
    if (isAuthenticated && !isLoading && !hasStored.current) {
      hasStored.current = true;
      storeUser().catch((err) => {
        console.error("Failed to store user:", err);
        // Reset so we can retry on next render
        hasStored.current = false;
      });
    }
    // Reset when user logs out so we store again on next login
    if (!isAuthenticated && !isLoading) {
      hasStored.current = false;
    }
  }, [isAuthenticated, isLoading, storeUser]);

  return { isAuthenticated, isLoading };
}
```

Create the hooks directory:
```bash
mkdir -p apps/web/hooks
```

This standalone version:
- Uses useConvexAuth instead of custom hook (for use outside provider context)
- Returns auth state for convenience
- Can be used in pages that need to ensure user exists before querying
  </action>
  <verify>
- `ls apps/web/hooks/useStoreUserEffect.ts` - file exists
- Exports useStoreUserEffect hook
- Uses useConvexAuth from convex/react
  </verify>
  <done>Standalone useStoreUserEffect hook for explicit user sync</done>
</task>

</tasks>

<verification>
1. `ls apps/web/app/ConvexClientProvider.tsx apps/web/hooks/useStoreUserEffect.ts` - both exist
2. `grep "ConvexClientProvider" apps/web/app/layout.tsx` - provider integrated
3. `grep "AuthKitProvider" apps/web/app/layout.tsx` - AuthKit still present (wrapping Convex)
4. `grep "api.users.store" apps/web/app/ConvexClientProvider.tsx` - user store called

Note: Full runtime verification requires NEXT_PUBLIC_CONVEX_URL set and Convex dev running.
</verification>

<success_criteria>
- ConvexClientProvider exports and works
- Layout wraps app with ConvexClientProvider inside AuthKitProvider
- User is automatically stored in Convex on authentication
- useStoreUserEffect hook available for manual use
</success_criteria>

<output>
After completion, create `.planning/phases/02-org-structure-languages/02-04-SUMMARY.md`
</output>
