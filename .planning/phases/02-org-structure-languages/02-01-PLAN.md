---
phase: 02-org-structure-languages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/convex/schema.ts
  - apps/web/convex/auth.config.ts
  - apps/web/convex/tsconfig.json
  - apps/web/.env.local
autonomous: true
user_setup:
  - service: convex
    why: "Database and serverless functions"
    account_setup: "Create Convex account at convex.dev if not already"
    env_vars:
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "npx convex dev will output this URL after deployment"
    dashboard_config:
      - task: "Set WORKOS_CLIENT_ID environment variable"
        location: "Convex Dashboard -> Settings -> Environment Variables"

must_haves:
  truths:
    - "Convex dev server connects successfully"
    - "Schema deploys without errors"
    - "WorkOS JWT validation is configured"
  artifacts:
    - path: "apps/web/convex/schema.ts"
      provides: "Database schema with users, stakes, wards, memberships"
      contains: "defineSchema"
    - path: "apps/web/convex/auth.config.ts"
      provides: "WorkOS JWT validation configuration"
      contains: "customJwt"
  key_links:
    - from: "apps/web/convex/auth.config.ts"
      to: "WorkOS JWKS endpoint"
      via: "WORKOS_CLIENT_ID env var"
      pattern: "api\\.workos\\.com/sso/jwks"
---

<objective>
Set up Convex database with schema for org hierarchy (users, stakes, wards, memberships) and WorkOS JWT auth integration.

Purpose: Establish the data layer foundation for stake/ward management
Output: Working Convex backend with schema deployed and auth configured
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-org-structure-languages/02-RESEARCH.md
@apps/web/package.json
@apps/web/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex and initialize project</name>
  <files>apps/web/package.json, apps/web/convex/</files>
  <action>
Install Convex SDK and run initialization:

```bash
cd apps/web
pnpm add convex
npx convex init
```

This creates the convex/ directory with _generated/ folder.

Create convex/tsconfig.json for proper TypeScript config:
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "lib": ["ES2021", "DOM"],
    "skipLibCheck": true,
    "allowJs": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true
  },
  "include": ["./**/*"],
  "exclude": ["_generated"]
}
```

DO NOT run `npx convex dev` yet - that requires user to authenticate with Convex.
  </action>
  <verify>
- `ls apps/web/convex/` shows directory exists
- `pnpm ls convex` shows convex installed in apps/web
  </verify>
  <done>Convex package installed and convex/ directory initialized</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema</name>
  <files>apps/web/convex/schema.ts</files>
  <action>
Create schema.ts with the hierarchical org structure:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // Users linked to WorkOS identities
  users: defineTable({
    name: v.string(),
    email: v.string(),
    tokenIdentifier: v.string(),
  }).index("by_token", ["tokenIdentifier"]),

  // Stakes (top-level org)
  stakes: defineTable({
    name: v.string(),
    supportedLanguages: v.array(v.union(v.literal("en"), v.literal("es"))),
    createdBy: v.id("users"),
  }),

  // Wards belong to stakes
  wards: defineTable({
    name: v.string(),
    stakeId: v.id("stakes"),
    supportedLanguages: v.optional(v.array(v.union(v.literal("en"), v.literal("es")))),
    createdBy: v.id("users"),
  }).index("by_stake", ["stakeId"]),

  // Memberships link users to orgs with roles
  memberships: defineTable({
    userId: v.id("users"),
    orgType: v.union(v.literal("stake"), v.literal("ward")),
    orgId: v.string(), // Store as string since it can be either stakes or wards ID
    role: v.union(v.literal("leader"), v.literal("member")),
  })
    .index("by_user", ["userId"])
    .index("by_org", ["orgType", "orgId"]),
});
```

Key design decisions:
- `tokenIdentifier` links to WorkOS identity
- `supportedLanguages` is required on stakes, optional on wards (inherits from stake)
- `memberships` uses orgId as string since Convex doesn't support union of IDs cleanly
- Indexes on `by_token`, `by_stake`, `by_user`, `by_org` for efficient queries
  </action>
  <verify>
- `cat apps/web/convex/schema.ts` shows all four tables
- Schema includes all required indexes
  </verify>
  <done>Schema defines users, stakes, wards, memberships with proper indexes</done>
</task>

<task type="auto">
  <name>Task 3: Configure WorkOS JWT auth for Convex</name>
  <files>apps/web/convex/auth.config.ts</files>
  <action>
Create auth.config.ts to validate WorkOS JWTs:

```typescript
// WorkOS JWT validation for Convex
// Requires WORKOS_CLIENT_ID env var set in Convex dashboard

export default {
  providers: [
    {
      // WorkOS User Management JWT format
      type: "customJwt" as const,
      issuer: process.env.WORKOS_CLIENT_ID 
        ? `https://api.workos.com/user_management/${process.env.WORKOS_CLIENT_ID}`
        : "https://api.workos.com/",
      algorithm: "RS256" as const,
      jwks: process.env.WORKOS_CLIENT_ID
        ? `https://api.workos.com/sso/jwks/${process.env.WORKOS_CLIENT_ID}`
        : undefined,
    },
    {
      // WorkOS SSO JWT format (fallback)
      type: "customJwt" as const,
      issuer: "https://api.workos.com/",
      algorithm: "RS256" as const,
      jwks: process.env.WORKOS_CLIENT_ID
        ? `https://api.workos.com/sso/jwks/${process.env.WORKOS_CLIENT_ID}`
        : undefined,
    },
  ],
};
```

NOTE: WORKOS_CLIENT_ID must be set in Convex Dashboard environment variables (not in .env.local). This is handled in user_setup.
  </action>
  <verify>
- `cat apps/web/convex/auth.config.ts` shows both JWT provider configs
- File exports default config object
  </verify>
  <done>WorkOS JWT auth configured for both User Management and SSO issuer formats</done>
</task>

</tasks>

<verification>
Run these checks to verify plan completion:

1. `ls apps/web/convex/` shows: schema.ts, auth.config.ts, tsconfig.json, _generated/
2. `cat apps/web/package.json | grep convex` shows convex dependency
3. Schema file contains defineSchema with 4 tables
4. Auth config contains both customJwt providers

Note: Full verification requires running `npx convex dev` which needs Convex account auth (see user_setup).
</verification>

<success_criteria>
- Convex SDK installed in apps/web
- convex/ directory exists with schema.ts and auth.config.ts
- Schema defines users, stakes, wards, memberships tables
- Auth config validates WorkOS JWTs
</success_criteria>

<output>
After completion, create `.planning/phases/02-org-structure-languages/02-01-SUMMARY.md`
</output>
