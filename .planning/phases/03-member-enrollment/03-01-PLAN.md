---
phase: 03-member-enrollment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/convex/schema.ts
autonomous: true
---

<objective>
Add search indexes on stakes and wards name fields, and a composite membership index for efficient duplicate checking.

Purpose: Enable full-text search for stake/ward discovery and fast membership lookups
Output: Updated schema with search indexes and composite index deployed
</objective>

<context>
@.planning/phases/03-member-enrollment/03-RESEARCH.md
@packages/backend/convex/schema.ts
</context>

<tasks>

<task type="code">
  <name>Task 1: Add search index to stakes table</name>
  <file>packages/backend/convex/schema.ts</file>
  <action>
Add `.searchIndex("search_name", { searchField: "name" })` to the stakes table definition.
  </action>
</task>

<task type="code">
  <name>Task 2: Add search index to wards table</name>
  <file>packages/backend/convex/schema.ts</file>
  <action>
Add `.searchIndex("search_name", { searchField: "name", filterFields: ["stakeId"] })` to the wards table definition. This enables searching wards within a specific stake.
  </action>
</task>

<task type="code">
  <name>Task 3: Add composite membership index</name>
  <file>packages/backend/convex/schema.ts</file>
  <action>
Add `.index("by_user_org", ["userId", "orgType", "orgId"])` to the memberships table. This enables efficient "does this user belong to this org?" point queries needed for duplicate prevention in the join mutation.
  </action>
</task>

<task type="verify">
  <name>Task 4: Verify schema is valid TypeScript</name>
  <action>Run `npx tsc --noEmit` in packages/backend to verify the schema compiles correctly.</action>
</task>

</tasks>

<verification>
- Schema file compiles without TypeScript errors
- Search indexes defined on stakes.name and wards.name
- Composite index by_user_org on memberships for [userId, orgType, orgId]
- Existing indexes (by_token, by_stake, by_user, by_org) preserved
</verification>

<success_criteria>
- Schema updated with 2 search indexes and 1 new regular index
- No TypeScript compilation errors
</success_criteria>
